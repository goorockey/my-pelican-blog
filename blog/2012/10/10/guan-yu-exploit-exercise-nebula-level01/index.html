<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
        <meta name="author" content="goorockey" />
        <meta name="copyright" content="goorockey" />


<meta name="keywords" content="linux, security, programming, linux, " />

<meta property="og:title" content="关于exploit exercise nebula level01 "/>
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.goorockey.com/blog/2012/10/10/guan-yu-exploit-exercise-nebula-level01/" />
<meta property="og:description" content="" />
<meta property="og:site_name" content="Goorockey's Life" />
<meta property="og:article:author" content="goorockey" />
<meta property="og:article:published_time" content="2012-10-10T23:26:00" />
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关于exploit exercise nebula level01 ">
<meta name="twitter:description" content="">

        <title>关于exploit exercise nebula level01  · Goorockey's Life
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://www.goorockey.com/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://www.goorockey.com/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://www.goorockey.com/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://www.goorockey.com/theme/css/custom.css" media="screen">
        <link href="http://www.goorockey.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Goorockey's Life - Full Atom Feed" />
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-28958629-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://www.goorockey.com/"><span class=site-name>Goorockey's Life</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://www.goorockey.com">Home</a></li>
                            <li ><a href="http://www.goorockey.com/categories.html">Categories</a></li>
                            <li ><a href="http://www.goorockey.com/tags.html">Tags</a></li>
                            <li ><a href="http://www.goorockey.com/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://www.goorockey.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://www.goorockey.com/blog/2012/10/10/guan-yu-exploit-exercise-nebula-level01/"> 关于exploit exercise nebula level01  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#_1">题目</a></li>
<li><a href="#_2">原理</a></li>
<li><a href="#real-user-id-effective-user-idsaved-set-user-id-set-user-id-bit">real user ID, effective user ID，saved set-user-ID, set-user-ID bit</a></li>
<li><a href="#bash">bash</a></li>
<li><a href="#system">system()的安全问题</a></li>
<li><a href="#_3">结语</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
            
<p>今天做<a href="http://exploit-exercises.com/">exploit exercise</a>的nebula <a href="http://exploit-exercises.com/nebula/level01">level01</a>，长见识了，记录一下。</p>
<h2 id="_1">题目</h2>
<p>题目提供了/home/flag01/下flag01的源码：</p>
<div class="highlight"><pre><span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">gid_t</span> <span class="n">gid</span><span class="p">;</span>
    <span class="kt">uid_t</span> <span class="n">uid</span><span class="p">;</span>
    <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">geteuid</span><span class="p">();</span>

    <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
    <span class="n">setresuid</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>

    <span class="n">system</span><span class="p">(</span><span class="s">"/usr/bin/env echo and now what?"</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>flag01的权限：</p>
<p>-rwsr-x--- 1 flag01 level01 7322 2011-11-20 21:22 flag01</p>
<p>flag01的uid是用户flag01,gid是level01,suid位被使能了</p>
<!-- more -->
<p><strong>解决方法</strong>网上都有：</p>
<div class="highlight"><pre><span class="err">$</span> <span class="n">export</span> <span class="n">PATH</span><span class="o">=/</span><span class="n">tmp</span><span class="o">:</span><span class="err">$</span><span class="n">PATH</span>    <span class="err">#</span> <span class="err">把</span><span class="o">/</span><span class="n">tmp</span><span class="err">加到环境变量</span><span class="n">PATH</span><span class="err">的最前头</span>
<span class="err">$</span> <span class="n">cat</span> <span class="s">"/bin/bash"</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">echo</span> <span class="err">#</span> <span class="err">在</span><span class="o">/</span><span class="n">tmp</span><span class="err">创建一个</span><span class="n">echo</span><span class="err">文件，里面是执行</span><span class="n">bash</span>
<span class="err">$</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">echo</span> <span class="err">#</span> <span class="err">把</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">echo</span><span class="err">设为执行文件</span>
<span class="err">$</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">flag01</span><span class="o">/</span><span class="n">flag01</span> <span class="err">#</span> <span class="err">执行</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">flag01</span><span class="err">下的</span><span class="n">flag01</span>

<span class="cp"># 顺利以用户flag01起bash</span>
<span class="err">$</span> <span class="n">getflag</span> <span class="err">#</span> <span class="err">通关</span>
</pre></div>
<h2 id="_2">原理</h2>
<p>主要原理网上的解法都说得很明白，就是通过env使得执行的echo是我们创建的假echo，成功以用户flag01的权限起bash</p>
<p>我想记录的主要是前面关于uid,gid的操作。</p>
<p><strong>为什么system之前会有getegid,setresgid这些操作呢？没有会怎样？这还会成功吗？</strong></p>
<p>答案是不行的！在<a href="http://stackoverflow.com/questions/8304396/what-is-vulnerable-about-this-c-code">stackoverflow</a>找到解答:</p>
<blockquote>
<p>Note that the setting of real user ID, effective user ID and saved set-user-ID by a call to setresuid() before the call to system() in the vulnerable code posted in the question allows one to exploit the vulnerability even when only effective user ID is set to a privileged user ID and real user ID remains unprivileged (as is for example the case when relying on set-user-ID bit on a file as above). Without the call to setresuid() the shell run by system() would reset the effective user ID back to the real user ID making the exploit ineffective. However, in the case when the vulnerable code is run with real user ID of a privileged user, system() call alone is enough.</p>
<p>man page of sh:</p>
<p>If the shell is started with the effective user (group) id not equal to the real user (group) id, and the -p option is not supplied, no startup files are read, shell functions are not inherited from the environment, the SHELLOPTS variable, if it appears in the environment, is ignored, and the effective user id is set to the real user id. If the -p option is supplied at invocation, the startup behavior is the same, but the effective user id is not reset.</p>
</blockquote>
<h2 id="real-user-id-effective-user-idsaved-set-user-id-set-user-id-bit">real user ID, effective user ID，saved set-user-ID, set-user-ID bit</h2>
<p>首先明确什么是real user ID, effective user ID，saved set-user-ID, set-user-ID bit</p>
<ul>
<li>real user ID 就是起进程的用户ID。</li>
<li>effective user ID是进程的有效用户ID，决定这个进程对文件系统操作的权限。如果它是root，那这个进程的操作就是以root的权限了。</li>
<li>set-user-id bit是程序的一个特征位，默认不使能，可以通过chmod +s 设置。当set-user-id被使能时，此程序叫SUID程序，程序启动时进程的effective user ID就是这个程序的uid；当set-user-id没被使能，则effective user ID是执行者real user ID。</li>
<li>saved set-user-ID保存着进程启动时effective user ID的值。</li>
</ul>
<p>因为进程内可以通过setuid等来设置effective user ID，也就改变了进程对文件系统操作的权限。但这不是可以随便设为任意的id的。</p>
<ul>
<li>如果进程有管理员权限，则setuid可以把effective user ID设为任意id.</li>
<li>如果进程没有管理员权限，则setuid只能把effective user ID设为real user ID或者saved set-user-id。</li>
</ul>
<p>这就知道saved set-user-ID有什么用了。它就是当程序是SUID程序时，effective user ID可以被设为real user ID和程序启动时的effective user ID，saved set-user-ID就是用来保存这个程序启动时effective user ID的值的，使得setuid可以把effective user ID可以从real user ID设回来。</p>
<h2 id="bash">bash</h2>
<p>然后就是起bash时，如果effective user ID跟real user ID不同，且real user ID不是管理员权限用户，则会把effective user ID设回real user ID。</p>
<p>而我们这样如果没有setresgid,setresuid的话，real user ID是level01, effective user ID是flag01, 起bash时，effective user ID会被设回real user ID，那还只是以level01起bash，而不是flag01起bash了。</p>
<h2 id="system">system()的安全问题</h2>
<p>在这里也可以看到system()是有安全问题的，因为system()里面是fork完就直接调用execl，使得继承了父进程的effective user ID的子进程执行新的程序。</p>
<p>APUE也说了:</p>
<blockquote>
<p>If it is running with special permissions--eithere set-user-ID or set-group-ID--and wants to spawn another process, a process should use fork() and exec() directly, being certain to change back to normal permissions after the fork(), before calling exec(). The system() function should never be used from a set-user-ID or a set-groupd-ID program.</p>
</blockquote>
<p>意思在SUID程序中，不应该用system()，而是自己写fork()和exec()来实现，并在fork和exec中间，自己处理好id权限问题。</p>
<h2 id="_3">结语</h2>
<p>之前看APUE，用户id这里看得一头雾水，通过这个exercise，总算有点感觉了。</p>
            <hr/>
            
            <section>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                href="http://www.goorockey.com/blog/2012/10/10/guan-yu-exploit-exercise-nebula-level01/#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'goorockeyslife';
        var disqus_identifier = 'http://www.goorockey.com/blog/2012/10/10/guan-yu-exploit-exercise-nebula-level01/';
    var disqus_url = 'http://www.goorockey.com/blog/2012/10/10/guan-yu-exploit-exercise-nebula-level01/';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="http://www.goorockey.com/blog/2012/09/30/pythonfa-you-jian-jiao-ben/" title="Previous: python发邮件脚本">python发邮件脚本</a></li>
                <li class="next-article"><a href="http://www.goorockey.com/blog/2012/10/21/wan-yi-xia-hadoop/" title="Next: 玩一下hadoop">玩一下hadoop</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2012-10-10T23:26:00">Oct 10, 2012</time>
            <h4>Category</h4>
            <a class="category-link" href="http://www.goorockey.com/categories.html#linux-ref">linux</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://www.goorockey.com/tags.html#linux-ref">linux
                    <span>5</span>
</a></li>
                <li><a href="http://www.goorockey.com/tags.html#programming-ref">programming
                    <span>13</span>
</a></li>
                <li><a href="http://www.goorockey.com/tags.html#security-ref">security
                    <span>1</span>
</a></li>
            </ul>
<h4>Friends</h4>
<ul class="friend-link">
    <li>
        <a href="http://www.dian.org.cn">Dian</a>
    </li>
    <li>
        <a href="http://www.seedclass.com">SeedClass</a>
    </li>
    <li>
        <a href="http://www.thankcreate.com">ThankCreate</a>
    </li>
</ul>
<h4>Contact</h4>
    <a href="http://github.com/goorockey" title="My Github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="http://feed.goorockey.com" title="Subscribe in a reader" class="sidebar-social-links" target="_blank">
    <i class="fa fa-rss sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-license">本博客遵循CC协议2.5，即署名-非商业使用-相同方式共享。所有未明确注明转载来源的文章均为本博客原创文章，对于原创文章的转载请注明作者并保持原文链接，否则保留追究法律责任的权利。</li>
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'goorockeyslife';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>